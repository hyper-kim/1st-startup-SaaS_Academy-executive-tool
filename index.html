<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 관리 대시보드</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        form { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        textarea { width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>

    <h1>학생 관리</h1>

    <h2>신규 학생 일괄 등록 (텍스트)</h2>
    <form id="text-upload-form">
        <textarea id="student-text-block" rows="10" 
                  placeholder="학생 이름과 수강료를 한 줄에 하나씩 입력하세요.(교재비는 수강료 뒤에 별도로 명시후 작성하세요) &#10;예:&#10;노*연 250000&#10;이*창 250000&#10;안*영 250000 교재비 32000 &#10;박*재 80000" 
                  required></textarea>
        <button type="submit">일괄 등록하기</button>
    </form>

    <hr>

    <h2>학생 목록</h2>
    <table id="student-table">
        <thead>
            <tr>
                <th>이름</th>
                <th>기본 수강료</th>
                <th>메모</th>
                <th>관리</th>
            </tr>
        </thead>
        <tbody id="student-list">
            </tbody>
    </table>

    <script>
        // API 기본 주소 (Django 서버 주소)
        const API_URL = 'https://special-enigma-pj5q5vj9vr563rv9r-8000.app.github.dev/api';

        const textForm = document.getElementById('text-upload-form');
        const textBlock = document.getElementById('student-text-block');
        const studentList = document.getElementById('student-list');

        /**
         * (페이지 로드 시) 1. 학생 목록 불러오기
         */
        async function fetchStudents() {
            try {
                const response = await fetch(`${API_URL}/students/`);
                if (!response.ok) throw new Error('서버 응답 실패');
                
                const students = await response.json();
                
                studentList.innerHTML = ''; // 목록 비우기
                
                students.forEach(student => {
                    studentList.innerHTML += `
                        <tr id="student-row-${student.id}">
                            <td>${student.name}</td>
                            <td>${student.base_fee.toLocaleString()}원</td>
                            <td>${student.notes}</td>
                            <td>
                                <button class="delete-btn" onclick="deleteStudent(${student.id})">
                                    삭제
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('학생 목록 로딩 실패:', error);
                studentList.innerHTML = '<tr><td colspan="4">학생 목록을 불러오는 데 실패했습니다. Django 서버가 켜져 있는지, CORS 설정이 되어 있는지 확인하세요.</td></tr>';
            }
        }

        /**
         * (폼 제출 시) 2. 신규 학생 텍스트 블록 업로드
         */
        textForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // 폼 자동 제출 방지
            
            const rawText = textBlock.value;
            if (!rawText.trim()) {
                alert('등록할 학생 정보를 입력하세요.');
                return;
            }

            try {
                // 'students/upload_text_batch/'라는 새 API로 텍스트 전송
                const response = await fetch(`${API_URL}/students/upload_text_batch/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'student_data': rawText 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`${result.count}명의 학생이 성공적으로 등록되었습니다.`);
                    fetchStudents(); // 목록 새로고침
                    textForm.reset(); // 입력창 비우기
                } else {
                    const error = await response.json();
                    alert(`업로드 실패: ${error.error || '알 수 없는 오류'}`);
                }
            } catch (error) {
                console.error('업로드 중 네트워크 오류:', error);
                alert('서버에 연결할 수 없습니다.');
            }
        });
        
        /**
         * 3. 학생 삭제하기
         */
        async function deleteStudent(id) {
            if (!confirm(`정말 이 학생을 삭제하시겠습니까? (ID: ${id})`)) return;
            
            try {
                const response = await fetch(`${API_URL}/students/${id}/`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    fetchStudents(); // 목록 새로고침
                } else {
                    alert('학생 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('학생 삭제 실패:', error);
                alert('서버에 연결할 수 없습니다.');
            }
        }

        // 페이지가 처음 열릴 때 학생 목록을 불러옵니다.
        fetchStudents();
    </script>
</body>
</html>