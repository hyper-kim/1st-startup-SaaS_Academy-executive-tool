<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        form { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        textarea { width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>

    <h1>í•™ìƒ ê´€ë¦¬</h1>

    <h2>ì‹ ê·œ í•™ìƒ ì¼ê´„ ë“±ë¡ (í…ìŠ¤íŠ¸)</h2>
    <form id="text-upload-form">
        <textarea id="student-text-block" rows="10" 
                  placeholder="í•™ìƒ ì´ë¦„ê³¼ ìˆ˜ê°•ë£Œë¥¼ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”.(êµì¬ë¹„ëŠ” ìˆ˜ê°•ë£Œ ë’¤ì— ë³„ë„ë¡œ ëª…ì‹œí›„ ì‘ì„±í•˜ì„¸ìš”) &#10;ì˜ˆ:&#10;ë…¸*ì—° 250000&#10;ì´*ì°½ 250000&#10;ì•ˆ*ì˜ 250000 êµì¬ë¹„ 32000 &#10;ë°•*ì¬ 80000" 
                  required></textarea>
        <button type="submit">ì¼ê´„ ë“±ë¡í•˜ê¸°</button>
    </form>

    <hr>

    <h2>í•™ìƒ ëª©ë¡</h2>
    <table id="student-table">
        <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>ê¸°ë³¸ ìˆ˜ê°•ë£Œ</th>
                <th>ë©”ëª¨</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="student-list">
            </tbody>
    </table>

    <hr>

    <h2>AI ì •ì‚° / ë°ì´í„° ì—…ë¡œë“œ</h2>
    <form id="matching-form">
        <p>ì€í–‰ ì´ì²´ ë‚´ì—­(í…ìŠ¤íŠ¸)ì„ ë¶™ì—¬ë„£ê±°ë‚˜, ì˜ìˆ˜ì¦ ì‚¬ì§„(ì´ë¯¸ì§€)ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
        
        <textarea id="text-input" rows="10" style="width: 100%;"
                  placeholder="[ì€í–‰ ì´ì²´ ë‚´ì—­ í…ìŠ¤íŠ¸]
ì›ì£¼ì •ì‚° 220,000
í˜„260810260 280,872
í•˜ë‚˜90924836 249,000"></textarea>

        <p>ë˜ëŠ” ì˜ìˆ˜ì¦/ìŠ¤í¬ë¦°ìƒ· ì´ë¯¸ì§€:</p>
        <input type="file" id="image-file" accept="image/*">

        <br><br>
        <button type="submit">AI ë§¤ì¹­ ì‹œì‘</button>
    </form>

    <h3>AI ë§¤ì¹­ ê²°ê³¼:</h3>
    <pre id="matching-results" style="background: #eee; padding: 10px; border-radius: 5px;">
ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
    </pre>

    <script>
        // API ê¸°ë³¸ ì£¼ì†Œ (Django ì„œë²„ ì£¼ì†Œ)
        // const API_URL = 'https://special-enigma-pj5q5vj9vr563rv9r-8000.app.github.dev/api';
        const API_URL = "http://127.0.0.1:8000/api"
        const textForm = document.getElementById('text-upload-form');
        const textBlock = document.getElementById('student-text-block');
        const studentList = document.getElementById('student-list');

        /**
         * (í˜ì´ì§€ ë¡œë“œ ì‹œ) 1. í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
         */
        async function fetchStudents() {
            try {
                const response = await fetch(`${API_URL}/students/`);
                if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨');
                
                const students = await response.json();
                
                studentList.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
                
                students.forEach(student => {
                    studentList.innerHTML += `
                        <tr id="student-row-${student.id}">
                            <td>${student.name}</td>
                            <td>${student.base_fee.toLocaleString()}ì›</td>
                            <td>${student.notes}</td>
                            <td>
                                <button class="delete-btn" onclick="deleteStudent(${student.id})">
                                    ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                studentList.innerHTML = '<tr><td colspan="4">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Django ì„œë²„ê°€ ì¼œì ¸ ìˆëŠ”ì§€, CORS ì„¤ì •ì´ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</td></tr>';
            }
        }

        /**
         * (í¼ ì œì¶œ ì‹œ) 2. ì‹ ê·œ í•™ìƒ í…ìŠ¤íŠ¸ ë¸”ë¡ ì—…ë¡œë“œ
         */
        textForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // í¼ ìë™ ì œì¶œ ë°©ì§€
            
            const rawText = textBlock.value;
            if (!rawText.trim()) {
                alert('ë“±ë¡í•  í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                // 'students/upload_text_batch/'ë¼ëŠ” ìƒˆ APIë¡œ í…ìŠ¤íŠ¸ ì „ì†¡
                const response = await fetch(`${API_URL}/students/upload_text_batch/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'student_data': rawText 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`${result.count}ëª…ì˜ í•™ìƒì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    fetchStudents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    textForm.reset(); // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                } else {
                    const error = await response.json();
                    alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('ì—…ë¡œë“œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
        
        /**
         * 3. í•™ìƒ ì‚­ì œí•˜ê¸°
         */
        async function deleteStudent(id) {
            if (!confirm(`ì •ë§ ì´ í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ID: ${id})`)) return;
            
            try {
                const response = await fetch(`${API_URL}/students/${id}/`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    fetchStudents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('í•™ìƒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('í•™ìƒ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        // ğŸ‘‡ [ìƒˆ ê¸°ëŠ¥] AI ë§¤ì¹­ í¼ì„ ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
        const matchingForm = document.getElementById('matching-form');
        const textInput = document.getElementById('text-input');
        const imageFile = document.getElementById('image-file');
        const matchingResults = document.getElementById('matching-results');

        // ... (fetchStudents, textForm.addEventListener, deleteStudent í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ë‘ ) ...


        // ğŸ‘‡ [ìƒˆ ê¸°ëŠ¥] 4. AI ë§¤ì¹­ í¼ ì œì¶œ ì´ë²¤íŠ¸
        matchingForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // í¼ ìë™ ì œì¶œ ë°©ì§€
            
            // 1. FormData ê°ì²´ ìƒì„± (íŒŒì¼ê³¼ í…ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ë³´ë‚´ê¸° ìœ„í•¨)
            const formData = new FormData();

            // 2. í…ìŠ¤íŠ¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            if (textInput.value.trim()) {
                formData.append('text_input', textInput.value);
            }

            // 3. ì´ë¯¸ì§€ íŒŒì¼ì´ ìˆìœ¼ë©´ ì¶”ê°€
            if (imageFile.files.length > 0) {
                formData.append('image_file', imageFile.files[0]);
            }
            
            if (!textInput.value.trim() && imageFile.files.length === 0) {
                alert('í…ìŠ¤íŠ¸ ë˜ëŠ” ì´ë¯¸ì§€ íŒŒì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            matchingResults.textContent = 'AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 10ì´ˆ ì†Œìš”)';

            try {
                // 4. 'matching/upload_data/' APIë¡œ FormData ì „ì†¡
                const response = await fetch(`${API_URL}/matching/upload_data/`, {
                    method: 'POST',
                    body: formData // FormDataëŠ” headersê°€ í•„ìš” ì—†ìŒ
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // 5. ê²°ê³¼ í‘œì‹œ
                    matchingResults.textContent = `[${result.message}]\n\n` + 
                                                  result.results.join('\n');
                    
                    // (ì„ íƒ) ë§¤ì¹­ ì„±ê³µ í›„ í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    // fetchStudents(); 
                } else {
                    const error = await response.json();
                    matchingResults.textContent = `ì˜¤ë¥˜: ${error.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                }

            } catch (error) {
                console.error('AI ë§¤ì¹­ ì‹¤íŒ¨:', error);
                matchingResults.textContent = 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }
        });

        // í˜ì´ì§€ê°€ ì²˜ìŒ ì—´ë¦´ ë•Œ í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        fetchStudents();
    </script>
</body>
</html>